{% extends "base/base_2.html" %}
{% load static %}
{% load jformat %}
{% load tags %}
{% block title %}
    {{ post.description|truncatewords:20 }}
{% endblock %}
{% block head %}
    <link rel="stylesheet" href="{% static "css/detail.css" %}">
{% endblock %}
{% block subcontent %}
    <article class="post" aria-label="پست" data-post-id="{{ post.id }}">
        <!-- Header -->
        <header class="post-header">
            <img class="avatar" src="{% if post.author.photo %}{{ post.author.photo.url }}{% endif %}"
                 alt="{{ post.author.username }}"/>
            <div class="user">
                <span class="name">{{ post.author.first_name }}</span>
                <span class="meta">{{ post.update|jformat:"%Y/%m/%d"|fa }}</span>
            </div>
            <button class="icon-btn dots" aria-label="بیشتر">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <circle cx="5" cy="12" r="2"/>
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="19" cy="12" r="2"/>
                </svg>
            </button>
        </header>

        <!-- Media -->
        <div class="post-media">
            <img src="{{ post.images.first.image.url }}" alt="تصویر پست"/>
        </div>

        <!-- Actions -->
        <div class="post-actions">
            <div class="left">
                <!-- Like (pure CSS toggle) -->
                <label class="icon-btn like-toggle like" aria-label="پسندیدن">
                    <input type="checkbox" class="check" {% if request.user in post.likes.all %}checked{% endif %}>
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path class="heart-stroke"
                              d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                              fill="none" stroke="currentColor" stroke-width="2"/>
                        <path class="heart-fill"
                              d="M12.1 18.55l-6.36-6.36a3.99 3.99 0 0 1 5.64-5.64l.62.62.62-.62a3.99 3.99 0 1 1 5.64 5.64l-6.16 6.36z"
                              fill="transparent"/>
                    </svg>
                </label>

                <!-- Comment -->
                <button class="icon-btn" aria-label="نظر">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                         aria-hidden="true">
                        <path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/>
                    </svg>
                </button>

                <!-- Share -->
                <button class="icon-btn" aria-label="اشتراک‌گذاری">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                         aria-hidden="true">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <path d="M8.59 13.51l6.83 3.98M15.41 6.51 8.59 10.49"/>
                    </svg>
                </button>
            </div>

            <!-- Bookmark (pure CSS toggle) -->
            <label class="icon-btn right bookmark-toggle" aria-label="ذخیره">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path class="bookmark-fill" d="M6 2h12a2 2 0 0 1 2 2v18l-8-4-8 4V4a2 2 0 0 1 2-2z"
                          fill="transparent"
                          stroke="currentColor" stroke-width="2"/>
                </svg>
            </label>
        </div>

        <!-- Body -->
        <div class="post-body">
            <div class="likes"><span id="count-like">{{ post.likes.count|fa }}</span> لایک</div>
            <p class="caption">
                <span class="name">{{ post.author.first_name }} {{ post.author.last_name }}</span>
                {{ post.description }}<span class="more">...بیشتر</span>
            </p>
            <div class="comments">
                {% for comment in post.comments.all %}
                    <div class="comment" data-id-comment="{{ comment.id }}">
                        <div class="detail">
                            <span class="name">{{ comment.author.username }}</span>
                            <p class="comment__text">{{ comment.message }}</p>
                        </div>
                        <div class="comment__like">
                            <div class="container_like">
                                <label for="like_button">{{ comment.likes.count|fa }}</label>
                                <button id="like_button" class="like_button">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                         class="svg1 {% if not request.user in comment.likes.all %}disable{% endif %}"
                                         id="svg1">
                                        <path d="M7.493 18.5c-.425 0-.82-.236-.975-.632A7.48 7.48 0 0 1 6 15.125c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183.89-.514 1.212-.924a9.042 9.042 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75A.75.75 0 0 1 15 2a2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H14.23c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23h-.777ZM2.331 10.727a11.969 11.969 0 0 0-.831 4.398 12 12 0 0 0 .52 3.507C2.28 19.482 3.105 20 3.994 20H4.9c.445 0 .72-.498.523-.898a8.963 8.963 0 0 1-.924-3.977c0-1.708.476-3.305 1.302-4.666.245-.403-.028-.959-.5-.959H4.25c-.832 0-1.612.453-1.918 1.227Z"/>
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5" stroke="currentColor"
                                         class="svg2 {% if request.user in comment.likes.all %}disable{% endif %}"
                                         id="svg2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m10.598-9.75H14.25M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5 9.5h1.053c.472 0 .745.556.5.96a8.958 8.958 0 0 0-1.302 4.665c0 1.194.232 2.333.654 3.375Z"/>
                                    </svg>

                                </button>
                            </div>
                            <div class="container_dislike">
                                <label for="dislike_button">{{ comment.dislikes.count|fa }}</label>
                                <button id="dislike_button" class="dislike_button">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                         class="svg1 {% if not request.user in comment.dislikes.all %}disable{% endif %}"
                                         id="svg1">
                                        <path d="M15.73 5.5h1.035A7.465 7.465 0 0 1 18 9.625a7.465 7.465 0 0 1-1.235 4.125h-.148c-.806 0-1.534.446-2.031 1.08a9.04 9.04 0 0 1-2.861 2.4c-.723.384-1.35.956-1.653 1.715a4.499 4.499 0 0 0-.322 1.672v.633A.75.75 0 0 1 9 22a2.25 2.25 0 0 1-2.25-2.25c0-1.152.26-2.243.723-3.218.266-.558-.107-1.282-.725-1.282H3.622c-1.026 0-1.945-.694-2.054-1.715A12.137 12.137 0 0 1 1.5 12.25c0-2.848.992-5.464 2.649-7.521C4.537 4.247 5.136 4 5.754 4H9.77a4.5 4.5 0 0 1 1.423.23l3.114 1.04a4.5 4.5 0 0 0 1.423.23ZM21.669 14.023c.536-1.362.831-2.845.831-4.398 0-1.22-.182-2.398-.52-3.507-.26-.85-1.084-1.368-1.973-1.368H19.1c-.445 0-.72.498-.523.898.591 1.2.924 2.55.924 3.977a8.958 8.958 0 0 1-1.302 4.666c-.245.403.028.959.5.959h1.053c.832 0 1.612-.453 1.918-1.227Z"/>
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5" stroke="currentColor"
                                         class="svg2 {% if request.user in comment.dislikes.all %}disable{% endif %}"
                                         id="svg2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M7.498 15.25H4.372c-1.026 0-1.945-.694-2.054-1.715a12.137 12.137 0 0 1-.068-1.285c0-2.848.992-5.464 2.649-7.521C5.287 4.247 5.886 4 6.504 4h4.016a4.5 4.5 0 0 1 1.423.23l3.114 1.04a4.5 4.5 0 0 0 1.423.23h1.294M7.498 15.25c.618 0 .991.724.725 1.282A7.471 7.471 0 0 0 7.5 19.75 2.25 2.25 0 0 0 9.75 22a.75.75 0 0 0 .75-.75v-.633c0-.573.11-1.14.322-1.672.304-.76.93-1.33 1.653-1.715a9.04 9.04 0 0 0 2.86-2.4c.498-.634 1.226-1.08 2.032-1.08h.384m-10.253 1.5H9.7m8.075-9.75c.01.05.027.1.05.148.593 1.2.925 2.55.925 3.977 0 1.487-.36 2.89-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398-.306.774-1.086 1.227-1.918 1.227h-1.053c-.472 0-.745-.556-.5-.96a8.95 8.95 0 0 0 .303-.54"/>
                                    </svg>


                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}


            </div>
            <div class="tags">
                <h6>تگ ها</h6>
                <div class="content">
                    {% for tag in post.tags.all %}
                        <a href="{% url 'social:posts' %}?tag={{ tag.slug }}">
                            <span>{{ tag.name }}</span>
                        </a>
                    {% endfor %}

                </div>

            </div>
        </div>

        <!-- Add comment -->
        <form class="add-comment" onsubmit="return false;">
            <button class="icon-btn" aria-label="ایموجی">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     aria-hidden="true">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 15s1.5 2 4 2 4-2 4-2"/>
                    <path d="M9 9h.01M15 9h.01"/>
                </svg>
            </button>
            <input type="text" placeholder="افزودن نظر..." aria-label="افزودن نظر"/>
            <button class="post-btn" disabled>ارسال</button>
        </form>
    </article>
{% endblock %}
{% block scripts %}
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            $(".like").click(function () {
                var post_id = $(this).closest(".post").data("post-id");
                var like_container = $("#count-like");
                var button = $(this).closest("input");
                var csrf_token = "{{ csrf_token }}";

                $.ajax({
                    type: "POST",
                    url: "{% url "social:like_post" %}",
                    data: {"post_id": post_id, "csrfmiddlewaretoken": csrf_token},
                    success: function (data) {
                        like_container.text(data.like_count);
                        if (data.like) {
                            button.attr("checked", "");
                        } else {
                            button.removeAttr("checked");
                        }
                    },

                });
            });
        });
    </script>

    <script>
        function like_or_dislike(element,subject) {
            const id_comment = $(element).closest(".comment").data("id-comment");
            const svg_1_like = $(element).closest(".comment").find('.container_like #svg1');
            const svg_2_like = $(element).closest(".comment").find('.container_like #svg2');
            const svg_1_dis = $(element).closest(".comment").find('.container_dislike #svg1');
            const svg_2_dis = $(element).closest(".comment").find('.container_dislike #svg2');
            const label_like = $(element).closest(".comment").find('.container_like label');
            const label_dislike = $(element).closest(".comment").find('.container_dislike label');

            $.ajax({
                type: "POST",
                url: "{% url "social:like_comment" %}",
                data: {"csrfmiddlewaretoken": '{{ csrf_token }}', "comment_id": id_comment, "subject": subject},
                success: function (data) {
                    if (data.like) {
                        svg_1_like.removeClass("disable");
                        svg_2_like.addClass("disable");
                    }
                    else {
                        svg_2_like.removeClass("disable");
                        svg_1_like.addClass("disable");
                    }
                    if (data.dislike) {
                        svg_1_dis.removeClass("disable");
                        svg_2_dis.addClass("disable");
                    }
                    else {
                        svg_2_dis.removeClass("disable");
                        svg_1_dis.addClass("disable");
                    }
                    label_like.text(data.count_like);
                    label_dislike.text(data.count_dislike);

                }
            });
        }
        $(document).ready(function (){
            $(".like_button").click(function () {
                like_or_dislike(this,'like');
            })
            $(".dislike_button").click(function () {
                like_or_dislike(this,'dislike');
            })
        });

    </script>
{% endblock %}
